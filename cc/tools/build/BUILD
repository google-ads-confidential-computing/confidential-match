# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

load("@io_bazel_rules_docker//container:container.bzl", "container_image")
load("@rules_distroless//apt:defs.bzl", "dpkg_statusd")
load("@rules_distroless//distroless:defs.bzl", "cacerts")

package(default_visibility = ["//visibility:public"])

# Packages added to the lookup server builder image, including dependencies.
# See lookup_server_builder_apt.yaml for the list of requested packages.
# When packages change, update this list with this command's output:
#   jq '.packages[].name' lookup_server_builder_apt.lock.json
LS_BUILDER_PACKAGE_NAMES = [
    "autoconf",
    "debianutils",
    "libc6",
    "libcrypt1",
    "libgcc-s1",
    "gcc-10-base",
    "m4",
    "libsigsegv2",
    "perl",
    "libperl5.32",
    "perl-modules-5.32",
    "perl-base",
    "dpkg",
    "tar",
    "libselinux1",
    "libpcre2-8-0",
    "libacl1",
    "zlib1g",
    "liblzma5",
    "libbz2-1.0",
    "libgdbm6",
    "libgdbm-compat4",
    "libdb5.3",
    "build-essential",
    "dpkg-dev",
    "binutils",
    "binutils-x86-64-linux-gnu",
    "libstdc++6",
    "libctf0",
    "libbinutils",
    "binutils-common",
    "libctf-nobfd0",
    "make",
    "patch",
    "xz-utils",
    "bzip2",
    "libdpkg-perl",
    "g++",
    "gcc-10",
    "libzstd1",
    "libmpfr6",
    "libgmp10",
    "libmpc3",
    "libisl23",
    "libgcc-10-dev",
    "libquadmath0",
    "libubsan1",
    "libtsan0",
    "liblsan0",
    "libasan6",
    "libatomic1",
    "libitm1",
    "libgomp1",
    "libcc1-0",
    "cpp-10",
    "g++-10",
    "libstdc++-10-dev",
    "libc6-dev",
    "libnsl-dev",
    "libtirpc-dev",
    "libtirpc3",
    "libtirpc-common",
    "libgssapi-krb5-2",
    "libkrb5support0",
    "libkrb5-3",
    "libssl1.1",
    "debconf",
    "libkeyutils1",
    "libk5crypto3",
    "libcom-err2",
    "libnsl2",
    "libcrypt-dev",
    "linux-libc-dev",
    "libc-dev-bin",
    "gcc",
    "cpp",
    "ca-certificates",
    "openssl",
    "clang-13",
    "libclang1-13",
    "libllvm13",
    "libz3-4",
    "libxml2",
    "libicu67",
    "libtinfo6",
    "libffi7",
    "libedit2",
    "libbsd0",
    "libmd0",
    "llvm-13-linker-tools",
    "libclang-common-13-dev",
    "libc6-i386",
    "lib32stdc++6",
    "lib32gcc-s1",
    "libobjc-10-dev",
    "libobjc4",
    "libgc1",
    "libclang-cpp13",
    "cmake",
    "libuv1",
    "librhash0",
    "libjsoncpp24",
    "libexpat1",
    "libcurl4",
    "libssh2-1",
    "libgcrypt20",
    "libgpg-error0",
    "librtmp1",
    "libnettle8",
    "libhogweed6",
    "libgnutls30",
    "libunistring2",
    "libtasn1-6",
    "libp11-kit0",
    "libidn2-0",
    "libpsl5",
    "libnghttp2-14",
    "libldap-2.4-2",
    "libsasl2-2",
    "libsasl2-modules-db",
    "libbrotli1",
    "libarchive13",
    "liblz4-1",
    "procps",
    "init-system-helpers",
    "lsb-base",
    "libprocps8",
    "libsystemd0",
    "libncursesw6",
    "libncurses6",
    "cmake-data",
    "curl",
    "docker.io",
    "tini",
    "runc",
    "libseccomp2",
    "iptables",
    "libnftnl11",
    "libmnl0",
    "libnfnetlink0",
    "libnetfilter-conntrack3",
    "netbase",
    "libxtables12",
    "libip6tc2",
    "libip4tc2",
    "containerd",
    "adduser",
    "passwd",
    "libpam-modules",
    "libpam-modules-bin",
    "libpam0g",
    "libaudit1",
    "libcap-ng0",
    "libaudit-common",
    "libsemanage1",
    "libsepol1",
    "libsemanage-common",
    "libdevmapper1.02.1",
    "dmsetup",
    "libudev1",
    "git",
    "git-man",
    "liberror-perl",
    "libcurl3-gnutls",
    "golang",
    "golang-src",
    "golang-1.15-src",
    "golang-go",
    "golang-1.15-go",
    "golang-doc",
    "golang-1.15-doc",
    "golang-1.15",
    "libcurl4-openssl-dev",
    "openjdk-11-jre",
    "libxtst6",
    "x11-common",
    "libxi6",
    "libxext6",
    "libx11-6",
    "libx11-data",
    "libxcb1",
    "libxdmcp6",
    "libxau6",
    "libxrender1",
    "libpng16-16",
    "libjpeg62-turbo",
    "libgif7",
    "libharfbuzz0b",
    "libgraphite2-3",
    "libglib2.0-0",
    "libpcre3",
    "libmount1",
    "libblkid1",
    "libfreetype6",
    "libgl1",
    "libglx0",
    "libglx-mesa0",
    "libgl1-mesa-dri",
    "libvulkan1",
    "libsensors5",
    "libsensors-config",
    "libllvm11",
    "libglapi-mesa",
    "libelf1",
    "libdrm2",
    "libdrm-common",
    "libdrm-radeon1",
    "libdrm-nouveau2",
    "libdrm-intel1",
    "libpciaccess0",
    "libdrm-amdgpu1",
    "libxxf86vm1",
    "libxshmfence1",
    "libxfixes3",
    "libxdamage1",
    "libxcb-xfixes0",
    "libxcb-sync1",
    "libxcb-shm0",
    "libxcb-present0",
    "libxcb-glx0",
    "libxcb-dri3-0",
    "libxcb-dri2-0",
    "libx11-xcb1",
    "libglvnd0",
    "openjdk-11-jre-headless",
    "libpcsclite1",
    "libasound2",
    "libasound2-data",
    "util-linux",
    "login",
    "libpam-runtime",
    "cdebconf",
    "libtextwrap1",
    "libslang2",
    "libnewt0.52",
    "libdebian-installer4",
    "libuuid1",
    "libsmartcols1",
    "libnss3",
    "libsqlite3-0",
    "libnspr4",
    "liblcms2-2",
    "libfontconfig1",
    "fontconfig-config",
    "fonts-texgyre",
    "ucf",
    "sensible-utils",
    "coreutils",
    "libattr1",
    "libcups2",
    "libavahi-common3",
    "libavahi-common-data",
    "libavahi-client3",
    "libdbus-1-3",
    "java-common",
    "ca-certificates-java",
    "default-jre-headless",
    "protobuf-compiler",
    "libprotoc23",
    "libprotobuf23",
    "python-is-python3",
    "python3",
    "libpython3-stdlib",
    "libpython3.9-stdlib",
    "libreadline8",
    "readline-common",
    "install-info",
    "libmpdec3",
    "tzdata",
    "mime-support",
    "media-types",
    "mailcap",
    "libpython3.9-minimal",
    "python3.9",
    "python3.9-minimal",
    "python3-minimal",
    "rsyslog",
    "liblognorm5",
    "libfastjson4",
    "libestr0",
    "socat",
    "libwrap0",
    "zlib1g-dev",
]

# Package installer build targets
LS_BUILDER_PACKAGES = [
    "@lookup_server_builder_apt//" + pkg + "/amd64"
    for pkg in LS_BUILDER_PACKAGE_NAMES
]

# Include package installation metadata
[
    dpkg_statusd(
        name = "dpkg_statusd_" + pkg,
        package_name = pkg,
        control = "@lookup_server_builder_apt//" + pkg + "/amd64:control",
        tags = ["manual"],
    )
    for pkg in LS_BUILDER_PACKAGE_NAMES
]

# Package installation status build targets
LS_BUILDER_PACKAGE_INSTALL_STATUSES = [
    "dpkg_statusd_" + pkg
    for pkg in LS_BUILDER_PACKAGE_NAMES
]

# Bundles ca-certificates as /etc/ssl/certs/ca-certificates.crt
# Images must set the environment variable SSL_CERT_FILE to this full file path
# https://github.com/GoogleContainerTools/rules_distroless/blob/v0.3.9/docs/rules.md#cacerts
cacerts(
    name = "cacerts",
    package = "@lookup_server_builder_apt//ca-certificates/amd64:data",
    tags = ["manual"],
)

container_image(
    name = "container_to_build_cc",
    base = "@debian_11//image",
    env = {
        # Required to use :cacerts, see that target definition for details
        "SSL_CERT_FILE": "/etc/ssl/certs/ca-certificates.crt",
        "CC": "/usr/bin/clang",
        "CXX": "/usr/bin/clang++",
    },
    files = ["@bazelisk//file"],
    symlinks = {
        "/usr/bin/bazel": "/bazelisk",
        "/usr/bin/clang": "/usr/bin/clang-13",
        "/usr/bin/clang++": "/usr/bin/clang++-13",
        "/usr/bin/clang-cpp": "/usr/bin/clang-cpp-13",
    },
    tags = ["manual"],
    tars = [
        ":cacerts",
    ] + LS_BUILDER_PACKAGES + LS_BUILDER_PACKAGE_INSTALL_STATUSES,
)
